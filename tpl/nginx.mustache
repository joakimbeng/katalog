server {
  listen 80 default_server;
  server_tokens off;
  server_name _; # This is just an invalid value which will never trigger on a real hostname.
  error_log /proc/self/fd/2;
  access_log /proc/self/fd/1;
{{#defaultServer}}
  proxy_buffering off;
  location / {
    proxy_pass http://default_host;
    include /etc/nginx/proxy_params;

    # HTTP 1.1 support
    proxy_http_version 1.1;

    # Websockets support
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Increase timeout
    proxy_connect_timeout  600;
    proxy_send_timeout     600;
    proxy_read_timeout     600;
    send_timeout           600;
  }
{{/defaultServer}}
{{^defaultServer}}
  return 503;
{{/defaultServer}}
}

{{#defaultServer}}
upstream default_host {
  {{#servers}}
    server {{ip}}:{{port}};
  {{/servers}}
}
{{/defaultServer}}

{{#vhosts}}
upstream {{slug}} {
  {{#servers}}
    server {{ip}}:{{port}};
  {{/servers}}
}

server {
  server_tokens off;
  server_name {{host}};
  proxy_buffering off;
  error_log /proc/self/fd/2;
  access_log /proc/self/fd/1;

  location / {
    proxy_pass http://{{slug}};
    include /etc/nginx/proxy_params;

    # HTTP 1.1 support
    proxy_http_version 1.1;

    # Websockets support
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Increase timeout
    proxy_connect_timeout  600;
    proxy_send_timeout     600;
    proxy_read_timeout     600;
    send_timeout           600;
  }
}
{{/vhosts}}
